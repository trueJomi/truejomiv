---
import LayoutLanding from "@/layout/LayoutLanding.astro";
import { getCV } from "../../services/cv.service";
import Home from "@/components/Landing/Home.astro";
import AboutMe from "../../components/Landing/AboutMe.astro";
import HeaderLanding from "../../layout/HeaderLanding.astro";
import Porfolio from "@/components/Landing/Porfolio/Porfolio.astro";
import Skills from "@/components/Landing/Skills/Skills.astro";
import Education from "@/components/Landing/Education/Education.astro";
import Contact from "@/components/Landing/Contact.astro";
import { getLangFromUrl } from "@/i18n/utils";
import { generateKeywords } from "@/const/seo";
import { CACHE_HEADERS } from "@/utils/ssr-config";

const lang = getLangFromUrl(Astro.url);
const isProduction = import.meta.env.PROD;
const isDev = import.meta.env.DEV;

// Solo aplicar headers de cache en producción
if (isProduction) {
    Object.entries(CACHE_HEADERS.DYNAMIC).forEach(([key, value]) => {
        Astro.response.headers.set(key, value);
    });
} else if (isDev) {
    // En desarrollo, deshabilitar cache
    Astro.response.headers.set('Cache-Control', 'no-cache, no-store, must-revalidate');
    Astro.response.headers.set('Pragma', 'no-cache');
    Astro.response.headers.set('Expires', '0');
}

const data = await getCV(lang);

if (
  data.basics === null ||
  data.basics.location === null
) {
    throw new Error("No se encontro el CV")
}

// SEO específico para la página en inglés
const pageTitle = "Jose Miguel Vasquez - Full Stack Developer";
const pageDescription = `${data.basics.summary || 'Full Stack Developer specialized in modern technologies'} - Professional portfolio with projects, experience and technical skills.`;
const pageKeywords = generateKeywords([
  ...data.skills.map(skill => skill.name),
  'Portfolio',
  'Projects',
  'Professional Experience',
  'Full Stack Developer'
]);

---
<LayoutLanding 
	title={pageTitle}
	description={pageDescription}
	keywords={pageKeywords}
	image={data.basics.image || '/favicon.ico'}
	type="profile"
	locale="en-US"
>
	<HeaderLanding image={data.basics.image} />
    <main class="w-full h-full md:pl-60 scroll-smooth">
        <Home basics={data.basics} />
        <AboutMe basics={data.basics}/>
        <Porfolio porfolio={data.projects} skills={data.skills} />
        <Education  education={data.educations} certificados={data.certificates} />
        <Skills skills={data.skills} />
        <Contact data={data.basics} skills={data.skills}/>
    </main>
</LayoutLanding>